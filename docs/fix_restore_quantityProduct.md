# üî• Plan X·ª≠ L√Ω V·∫•n ƒê·ªÅ Restore Quantity Khi H·ªßy ƒê∆°n H√†ng

## üìã T·ªïng Quan V·∫•n ƒê·ªÅ

### ‚úÖ Hi·ªán T·∫°i ƒê√£ C√≥:

- **API `/api/orders/rollback-inventory`**: Restore inventory + voucher rollback ho√†n ch·ªânh
- **T·ª± ƒë·ªông g·ªçi rollback**: Trong MoMo callback khi payment failed
- **Transaction atomic**: ƒê·∫£m b·∫£o consistency khi restore

### ‚ùå V·∫•n ƒê·ªÅ Ph√°t Hi·ªán:

1. **User Cancel Order** (`/api/orders/cancel`) - KH√îNG restore inventory
2. **Admin Cancel Order** (`/api/orders/admin-cancel`) - KH√îNG restore inventory
3. **Discord Cancel Order** (`/api/discord/interactions`) - KH√îNG restore inventory
4. **Rollback API ch·ªâ support PENDING orders** - Kh√¥ng handle confirmed orders

## üéØ Ph√¢n T√≠ch Chi Ti·∫øt C√°c API H·ªßy ƒê∆°n H√†ng

### 1. `/api/orders/cancel/route.ts` - User Cancel

```typescript
// ‚ùå THI·∫æU: Ch·ªâ update status, KH√îNG restore inventory
const updatedOrder = await prisma.order.update({
  where: { id: orderId },
  data: {
    status: OrderStatus.canceled,
    cancelReason: reason,
    cancelDate: new Date()
  }
});
// ‚ùå KH√îNG g·ªçi rollback-inventory API
```

### 2. `/api/orders/admin-cancel/route.ts` - Admin Cancel

```typescript
// ‚ùå THI·∫æU: Ch·ªâ update status, KH√îNG restore inventory
const updatedOrder = await prisma.order.update({
  where: { id: orderId },
  data: {
    status: OrderStatus.canceled,
    cancelReason: reason,
    cancelDate: new Date()
  }
});
// ‚ùå KH√îNG g·ªçi rollback-inventory API
```

### 3. `/api/discord/interactions/route.ts` - Discord Cancel

```typescript
// ‚ùå THI·∫æU: Ch·ªâ update status, KH√îNG restore inventory
await prisma.order.update({
  where: { id: orderId },
  data: {
    status: newStatus,
    ...(cancelReason && {
      cancelReason: cancelReason,
      cancelDate: new Date()
    })
  }
});
// ‚ùå KH√îNG g·ªçi rollback-inventory API
```

### 4. `/api/orders/rollback-inventory/route.ts` - Hi·ªán T·∫°i

```typescript
// ‚úÖ ƒê√öNG: Restore inventory + voucher atomically
// ‚ùå H·∫†N CH·∫æ: Ch·ªâ cho ph√©p PENDING orders
if (order.status !== OrderStatus.pending) {
  return NextResponse.json(
    {
      error: `Cannot rollback order with status: ${order.status}`
    },
    { status: 400 }
  );
}
```

## üîß Plan S·ª≠a Ch·ªØa Chi Ti·∫øt

### Phase 1: C·∫£i Thi·ªán Rollback API

**File**: `src/app/api/orders/rollback-inventory/route.ts`

#### 1.1 M·ªü R·ªông Support Cho Confirmed Orders

```typescript
// Thay ƒë·ªïi t·ª´:
if (order.status !== OrderStatus.pending)

// Th√†nh:
if (order.status !== OrderStatus.pending && order.status !== OrderStatus.confirmed)
```

#### 1.2 X·ª≠ L√Ω Variant Products ƒê√∫ng C√°ch

```typescript
// ‚ùå HI·ªÜN T·∫†I: Ch·ªâ restore simple products
await tx.product.update({
  where: { id: product.id },
  data: { inStock: { increment: product.quantity } }
});

// ‚úÖ C·∫¶N S·ª¨A: X·ª≠ l√Ω c·∫£ variant products
for (const product of order.products as any[]) {
  if (product.variantId) {
    // Restore variant stock
    await tx.productVariant.update({
      where: { id: product.variantId },
      data: { stock: { increment: product.quantity } }
    });

    // Recalculate main product stock
    const totalStock = await tx.productVariant.aggregate({
      where: { productId: product.id, isActive: true },
      _sum: { stock: true }
    });

    await tx.product.update({
      where: { id: product.id },
      data: { inStock: totalStock._sum.stock || 0 }
    });
  } else {
    // Simple product
    await tx.product.update({
      where: { id: product.id },
      data: { inStock: { increment: product.quantity } }
    });
  }
}
```

### Phase 2: T√≠ch H·ª£p Rollback V√†o C√°c API Cancel

#### 2.1 User Cancel API

**File**: `src/app/api/orders/cancel/route.ts`

```typescript
// Th√™m sau khi update order status th√†nh c√¥ng:
try {
  const baseUrl = process.env.NEXTAUTH_URL || process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
  await fetch(`${baseUrl}/api/orders/rollback-inventory`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      orderId,
      reason: `User cancelled: ${reason}`
    })
  });
} catch (rollbackError) {
  console.error('Error triggering inventory rollback:', rollbackError);
  // Log nh∆∞ng kh√¥ng fail to√†n b·ªô operation
}
```

#### 2.2 Admin Cancel API

**File**: `src/app/api/orders/admin-cancel/route.ts`

```typescript
// Th√™m sau khi update order status th√†nh c√¥ng:
try {
  const baseUrl = process.env.NEXTAUTH_URL || process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
  await fetch(`${baseUrl}/api/orders/rollback-inventory`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      orderId,
      reason: `Admin cancelled: ${reason}`
    })
  });
} catch (rollbackError) {
  console.error('Error triggering inventory rollback:', rollbackError);
  // Log nh∆∞ng kh√¥ng fail to√†n b·ªô operation
}
```

#### 2.3 Discord Cancel API

**File**: `src/app/api/discord/interactions/route.ts`

```typescript
// Th√™m sau khi update order status th√†nh c√¥ng (ch·ªâ khi action === 'reject'):
if (action === 'reject') {
  try {
    const baseUrl = process.env.NEXTAUTH_URL || process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
    await fetch(`${baseUrl}/api/orders/rollback-inventory`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        orderId,
        reason: cancelReason
      })
    });
  } catch (rollbackError) {
    console.error('Error triggering inventory rollback:', rollbackError);
    // Log nh∆∞ng kh√¥ng fail to√†n b·ªô operation
  }
}
```

### Phase 3: X·ª≠ L√Ω Edge Cases

#### 3.1 Ki·ªÉm Tra Tr·∫°ng Th√°i Delivery

```typescript
// Ch·ªâ restore inventory n·∫øu ch∆∞a ship
if (order.deliveryStatus === 'not_shipped') {
  // Proceed with rollback
} else {
  // Log warning nh∆∞ng kh√¥ng rollback
  console.warn(`Order ${orderId} already shipped, skipping inventory rollback`);
}
```

#### 3.2 Idempotency Protection

```typescript
// Ki·ªÉm tra order ƒë√£ b·ªã cancel ch∆∞a ƒë·ªÉ tr√°nh double rollback
const order = await prisma.order.findUnique({
  where: { id: orderId },
  select: { status: true /* other fields */ }
});

if (order.status === OrderStatus.canceled) {
  return NextResponse.json({
    success: true,
    message: 'Order already cancelled, no rollback needed'
  });
}
```

## üß™ Testing Plan

### Test Cases C·∫ßn Ki·ªÉm Tra:

1. **Simple Product Cancel**:

   - T·∫°o order v·ªõi simple product ‚Üí Cancel ‚Üí Verify stock restored

2. **Variant Product Cancel**:

   - T·∫°o order v·ªõi variant product ‚Üí Cancel ‚Üí Verify variant stock + main product stock restored

3. **Mixed Products Cancel**:

   - T·∫°o order v·ªõi c·∫£ simple + variant ‚Üí Cancel ‚Üí Verify c·∫£ 2 lo·∫°i ƒë·ªÅu restored

4. **Voucher Rollback**:

   - T·∫°o order v·ªõi voucher ‚Üí Cancel ‚Üí Verify voucher usage count restored

5. **Different Cancel Methods**:

   - Test user cancel, admin cancel, Discord cancel ‚Üí T·∫•t c·∫£ ƒë·ªÅu restore inventory

6. **Edge Cases**:
   - Cancel order ƒë√£ shipped ‚Üí Kh√¥ng restore
   - Cancel order ƒë√£ cancelled ‚Üí Idempotent
   - Network failure trong rollback ‚Üí Graceful handling

## üìù Checklist Implementation

- [ ] **Phase 1**: C·∫£i thi·ªán rollback API

  - [ ] Support confirmed orders
  - [ ] X·ª≠ l√Ω variant products ƒë√∫ng c√°ch
  - [ ] Th√™m delivery status check
  - [ ] Th√™m idempotency protection

- [ ] **Phase 2**: T√≠ch h·ª£p v√†o cancel APIs

  - [ ] User cancel API
  - [ ] Admin cancel API
  - [ ] Discord cancel API

- [ ] **Phase 3**: Testing & Validation

  - [ ] Unit tests cho rollback logic
  - [ ] Integration tests cho cancel flows
  - [ ] Manual testing v·ªõi UI

- [ ] **Phase 4**: Documentation & Monitoring
  - [ ] Update API documentation
  - [ ] Add monitoring/alerting cho rollback failures
  - [ ] Update README.md

## ‚ö†Ô∏è L∆∞u √ù Quan Tr·ªçng

1. **Kh√¥ng Fail To√†n B·ªô Operation**: N·∫øu rollback fail, v·∫´n cho ph√©p cancel order th√†nh c√¥ng
2. **Async Rollback**: G·ªçi rollback API async ƒë·ªÉ kh√¥ng block user experience
3. **Audit Logging**: ƒê·∫£m b·∫£o t·∫•t c·∫£ rollback actions ƒë·ªÅu ƒë∆∞·ª£c log
4. **Transaction Safety**: Rollback API ƒë√£ c√≥ transaction, c√°c cancel API ch·ªâ c·∫ßn g·ªçi
5. **Backward Compatibility**: Kh√¥ng breaking changes cho existing functionality

## üîç Ph√¢n T√≠ch Th√™m V·ªÅ Variant Products

### V·∫•n ƒê·ªÅ Hi·ªán T·∫°i Trong Rollback API:

```typescript
// ‚ùå HI·ªÜN T·∫†I: Ch·ªâ restore simple products
for (const product of order.products as any[]) {
  await tx.product.update({
    where: { id: product.id },
    data: { inStock: { increment: product.quantity } }
  });
}
```

### C√°ch X·ª≠ L√Ω ƒê√∫ng:

1. **Ki·ªÉm tra product c√≥ variantId kh√¥ng**
2. **N·∫øu c√≥ variant**: Restore variant stock + recalculate main product stock
3. **N·∫øu simple**: Restore tr·ª±c ti·∫øp main product stock

### Tham Kh·∫£o Logic T·ª´ Create Order:

<augment_code_snippet path="src/app/api/orders/create-payment-intent/route.ts" mode="EXCERPT">

```typescript
// 2a. Reserve variant inventory atomically
await tx.productVariant.update({
  where: { id: product.variantId },
  data: { stock: { decrement: product.quantity } }
});

// 2b. Update main product stock (sum of all variant stocks)
const totalStock = await tx.productVariant.aggregate({
  where: {
    productId: product.id,
    isActive: true
  },
  _sum: { stock: true }
});

await tx.product.update({
  where: { id: product.id },
  data: { inStock: totalStock._sum.stock || 0 }
});
```

</augment_code_snippet>

## üö® C√°c Tr∆∞·ªùng H·ª£p C·∫ßn X·ª≠ L√Ω ƒê·∫∑c Bi·ªát

### 1. Order ƒê√£ Shipped

- **Kh√¥ng restore inventory** v√¨ h√†ng ƒë√£ giao
- **Log warning** ƒë·ªÉ tracking
- **V·∫´n mark order as cancelled** cho audit trail

### 2. Double Cancellation

- **Ki·ªÉm tra status tr∆∞·ªõc khi rollback**
- **Return success** n·∫øu ƒë√£ cancelled (idempotent)
- **Tr√°nh double rollback** inventory

### 3. Partial Shipment (Future Enhancement)

- Hi·ªán t·∫°i ch∆∞a support partial shipment
- N·∫øu c√≥ trong t∆∞∆°ng lai c·∫ßn x·ª≠ l√Ω ri√™ng t·ª´ng item

### 4. Network Failures

- **Rollback API call fail**: Log error nh∆∞ng kh√¥ng fail cancel operation
- **User experience**: Cancel v·∫´n th√†nh c√¥ng t·ª´ UI perspective
- **Background job**: C√≥ th·ªÉ implement retry mechanism sau

## üìä Impact Analysis

### Tr∆∞·ªõc Khi Fix:

- ‚ùå User cancel order ‚Üí Inventory kh√¥ng ƒë∆∞·ª£c restore
- ‚ùå Admin cancel order ‚Üí Inventory kh√¥ng ƒë∆∞·ª£c restore
- ‚ùå Discord cancel order ‚Üí Inventory kh√¥ng ƒë∆∞·ª£c restore
- ‚ùå Variant products ‚Üí Rollback logic sai

### Sau Khi Fix:

- ‚úÖ T·∫•t c·∫£ cancel methods ƒë·ªÅu restore inventory
- ‚úÖ Variant products ƒë∆∞·ª£c x·ª≠ l√Ω ƒë√∫ng c√°ch
- ‚úÖ Voucher rollback ho·∫°t ƒë·ªông ƒë·∫ßy ƒë·ªß
- ‚úÖ Edge cases ƒë∆∞·ª£c handle gracefully
- ‚úÖ Backward compatibility ƒë∆∞·ª£c ƒë·∫£m b·∫£o
